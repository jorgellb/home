---
import '../styles/global.css';
import CookieBanner from '../components/common/CookieBanner.astro';
import StickyCTA from '../components/common/StickyCTA.astro';

interface Props {
  title: string;
  description: string;
  image?: string;
  imageAlt?: string;
  type?: 'website' | 'article' | 'product' | 'service';
  noindex?: boolean;
  canonical?: string;
  lang?: string;
  alternates?: Array<{ hreflang: string; href: string }>;
  jsonLd?: Record<string, unknown> | Record<string, unknown>[];
  keywords?: string;
  preload?: Array<{ href: string; as: string; type?: string }>;
}

const { 
  title, 
  description, 
  image, 
  imageAlt = 'Platanito Rico - Agencia Creativa Digital en Almería',
  type = 'website',
  noindex = false,
  canonical,
  lang = 'es',
  alternates,
  jsonLd,
  keywords = 'diseño web almería, agencia digital, marketing online, seo almería, desarrollo web, tiendas online',
  preload = []
} = Astro.props;

const siteName = 'Platanito Rico';
const siteBase = Astro.site ? Astro.site.origin : 'https://platanitorico.com';
const siteUrl = Astro.site ? new URL(Astro.url.pathname, Astro.site).href : Astro.url.href;
const canonicalUrl = canonical || siteUrl;
const ogImageRaw = image || '/og-image.jpg';
const ogImage = ogImageRaw.startsWith('http') ? ogImageRaw : `${siteBase}${ogImageRaw}`;
---

<!DOCTYPE html>
<html lang={lang} class="scroll-smooth">
  <head>
    <!-- Critical: charset + viewport first -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    
    <!-- Preconnects -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- DNS Prefetch -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- Preload critical assets -->
    {preload.map(resource => (
      <link rel="preload" href={resource.href} as={resource.as} type={resource.type} crossorigin />
    ))}
    
    <!-- Hreflang alternates -->
    {alternates && alternates.map((alt) => (
      <link rel="alternate" hreflang={alt.hreflang} href={alt.href} />
    ))}
    
    <!-- Primary Meta Tags -->
    <title>{title} | {siteName}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="author" content="Platanito Rico" />
    <meta name="robots" content={noindex ? 'noindex, nofollow' : 'index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'} />
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- Open Graph -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={`${title} | ${siteName}`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={imageAlt} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content="es_ES" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalUrl} />
    <meta name="twitter:title" content={`${title} | ${siteName}`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={imageAlt} />
    
    <!-- Google Fonts - Optimized -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/imagenes/icon.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/imagenes/icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#FF6B00" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Geo Tags -->
    <meta name="geo.region" content="ES-AL" />
    <meta name="geo.placename" content="Almería" />
    <meta name="geo.position" content="36.8340;-2.4637" />
    <meta name="ICBM" content="36.8340, -2.4637" />
    
    <!-- GSAP - Load conditionally based on page needs -->
    <script>
      // Only load GSAP if page has animations
      if (document.querySelector('[data-gsap]')) {
        const gsapScript = document.createElement('script');
        gsapScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js';
        gsapScript.defer = true;
        document.head.appendChild(gsapScript);
        
        const stScript = document.createElement('script');
        stScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js';
        stScript.defer = true;
        document.head.appendChild(stScript);
      }
    </script>
    
    <!-- JSON-LD -->
    {jsonLd && Array.isArray(jsonLd) 
      ? jsonLd.map((schema) => (
          <script type="application/ld+json" set:html={JSON.stringify(schema)} />
        ))
      : jsonLd && (
          <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
        )
    }
  </head>
  <body>
    <!-- Skip to main content -->
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    
    <slot />
    
    <!-- Sticky CTA for mobile -->
    <StickyCTA />

    <!-- Cookie Consent -->
    <CookieBanner />
    
    <!-- GSAP Animations - Only load if needed -->
    <script is:inline>
      if (document.querySelector('[data-gsap]') && typeof window.gsap !== 'undefined') {
        const script = document.createElement('script');
        script.src = '/scripts/gsap-animations.js';
        script.async = true;
        document.body.appendChild(script);
      }
    </script>
    
    <!-- Reduced motion support -->
    <script is:inline>
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        document.documentElement.style.setProperty('--transition-duration', '0.01ms');
        document.documentElement.classList.add('reduce-motion');
      }
    </script>
  </body>
</html>

<style>
  .skip-link {
    position: absolute;
    top: -100%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    padding: 0.75rem 1.5rem;
    background: #FF6B00;
    color: white;
    text-decoration: none;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: top 0.3s ease;
  }
  .skip-link:focus {
    top: 1rem;
    outline: 3px solid #fbbf24;
    outline-offset: 0.25rem;
  }
  
  /* Reduced motion support */
  .reduce-motion *,
  .reduce-motion *::before,
  .reduce-motion *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
</style>
